<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>CASPAM AI - 3D Edition</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050510;
            --glass-bg: rgba(20, 20, 35, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #00f2ff;
            --secondary: #7000ff;
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --msg-user-bg: linear-gradient(135deg, #7000ff, #4c00b0);
            --msg-bot-bg: rgba(30, 30, 45, 0.85);
            --font-main: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #bgCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Mobile Menu Button - SINGLE button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1002;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            flex-direction: column;
            gap: 5px;
            width: 45px;
            height: 45px;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .mobile-menu-btn .bar {
            width: 22px;
            height: 2px;
            background: var(--primary);
            border-radius: 3px;
            transition: 0.3s;
        }

        .mobile-menu-btn.active .bar:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        .mobile-menu-btn.active .bar:nth-child(2) {
            opacity: 0;
        }
        .mobile-menu-btn.active .bar:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Mobile Drawer - Combined menu */
        .mobile-drawer {
            display: none;
            position: fixed;
            top: 0;
            left: -100%;
            width: 85%;
            max-width: 320px;
            height: 100vh;
            background: rgba(10, 10, 20, 0.98);
            backdrop-filter: blur(20px);
            z-index: 1001;
            transition: left 0.3s ease;
            border-right: 1px solid var(--glass-border);
            overflow-y: auto;
            flex-direction: column;
        }

        .mobile-drawer.open {
            left: 0;
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drawer-tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
        }

        .drawer-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .drawer-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .drawer-content.active {
            display: block;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .mobile-overlay.active {
            display: block;
        }

        .app-container {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100vh;
            display: flex;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            overflow: hidden;
        }

        /* Left Sidebar - Desktop only */
        .sidebar {
            width: 260px;
            background: rgba(10, 10, 20, 0.95);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            height: 100vh;
            overflow-y: auto;
        }

        /* History Sidebar - Desktop only */
        .history-sidebar {
            width: 300px;
            background: rgba(10, 10, 20, 0.95);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        .brand {
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .brand span {
            color: var(--primary);
        }

        .nav-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 12px;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            width: 100%;
        }

        .nav-btn:hover {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--primary);
            color: white;
        }

        .sidebar-footer {
            margin-top: auto;
            font-size: 0.75rem;
            color: #555;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid var(--glass-border);
        }

        /* History Header */
        .history-header {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-header h3 {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .history-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }

        .history-item:hover {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--primary);
        }

        .history-item.active {
            border-color: var(--primary);
            background: rgba(0, 242, 255, 0.05);
        }

        .history-item-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            padding-right: 40px;
        }

        .history-item-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 40px;
        }

        .history-item-date {
            font-size: 0.7rem;
            color: #555;
            margin-top: 5px;
        }

        .history-item-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .history-item:hover .history-item-actions {
            opacity: 1;
        }

        .history-item-actions button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px 5px;
        }

        .header {
            padding: 15px 30px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            box-shadow: 0 0 8px #00ff88;
            display: inline-block;
            margin-right: 8px;
        }

        .messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .msg {
            max-width: 85%;
            padding: 16px 22px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .msg.user {
            background: var(--msg-user-bg);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            box-shadow: 0 5px 20px rgba(112, 0, 255, 0.3);
        }

        .msg.bot {
            background: var(--msg-bot-bg);
            color: var(--text-main);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid var(--glass-border);
        }

        .input-area {
            padding: 20px 30px;
            background: rgba(5, 5, 16, 0.95);
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 15px;
        }

        .input-area input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 15px 25px;
            color: white;
            outline: none;
            font-family: var(--font-main);
            font-size: 1rem;
        }

        .input-area input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .send-btn {
            background: var(--primary);
            color: black;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px var(--primary);
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #151525;
            padding: 30px;
            border-radius: 15px;
            width: 350px;
            border: 1px solid #333;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #0a0a0f;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Desktop styles */
        @media screen and (min-width: 769px) {
            .history-sidebar {
                border-left: 1px solid var(--glass-border);
            }
        }

        /* ========== MOBILE STYLES ========== */
        @media screen and (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }

            .mobile-drawer {
                display: flex;
            }

            .sidebar, .history-sidebar {
                display: none; /* Hide desktop sidebars on mobile */
            }

            .app-container {
                width: 100%;
                flex-direction: column;
            }

            .main-chat {
                width: 100%;
                height: 100vh;
            }

            .header {
                padding: 15px;
                padding-left: 70px;
                text-align: center;
            }

            .messages {
                padding: 15px;
                height: calc(100vh - 130px);
            }

            .msg {
                max-width: 90%;
                padding: 12px 16px;
                font-size: 0.9rem;
            }

            .input-area {
                padding: 10px 15px;
                position: sticky;
                bottom: 0;
                background: rgba(5, 5, 16, 0.98);
            }

            .input-area input {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            .send-btn {
                width: 45px;
                height: 45px;
            }

            .history-item-actions {
                opacity: 0.7;
            }
        }

        @media screen and (max-width: 480px) {
            .header {
                padding-left: 65px;
            }

            .msg {
                max-width: 95%;
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            .input-area input {
                padding: 10px 12px;
            }

            .send-btn {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>

    <!-- Single Mobile Menu Button -->
    <div class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileDrawer()">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <!-- Mobile Drawer (Combined Menu) -->
    <div class="mobile-drawer" id="mobileDrawer">
        <div class="drawer-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
            <span style="color: white; font-weight: 600;">CASPAM <span style="color: var(--primary);">AI</span></span>
        </div>
        
        <div class="drawer-tabs">
            <button class="drawer-tab active" onclick="switchDrawerTab('menu')">Menu</button>
            <button class="drawer-tab" onclick="switchDrawerTab('history')">History</button>
        </div>

        <!-- Menu Tab Content -->
        <div class="drawer-content active" id="menuTab">
            <button class="nav-btn" onclick="resetChat(); closeMobileDrawer();">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
                New Chat
            </button>
            <button class="nav-btn" onclick="clearHistory(); closeMobileDrawer();">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
                Clear History
            </button>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                <button class="nav-btn" onclick="exportHistory();">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Export History
                </button>
                <button class="nav-btn" onclick="importHistory();">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 5 17 10" />
                        <line x1="12" y1="5" x2="12" y2="15" />
                    </svg>
                    Import History
                </button>
            </div>
            <div class="sidebar-footer" style="margin-top: 20px;">
                BZU Multan<br>Dept. of Mathematics
            </div>
        </div>

        <!-- History Tab Content -->
        <div class="drawer-content" id="historyTab">
            <div style="padding: 10px 0;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="exportHistory()" class="history-btn" style="flex: 1;">ðŸ“¥ Export</button>
                    <button onclick="importHistory()" class="history-btn" style="flex: 1;">ðŸ“¤ Import</button>
                </div>
                <div id="mobileHistoryList" class="history-list" style="max-height: calc(100vh - 200px);"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileDrawer()"></div>

    <div class="app-container">
        <!-- Left Sidebar (Desktop) -->
        <aside class="sidebar">
            <div class="brand">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
                CASPAM <span>AI</span>
            </div>
            <button class="nav-btn" onclick="resetChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
                New Chat
            </button>
            <button class="nav-btn" onclick="clearHistory()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
                Clear History
            </button>
            <div class="sidebar-footer">
                BZU Multan<br>Dept. of Mathematics
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-chat">
            <header class="header">
                <div style="font-weight: 600; font-size: 1.1rem; display:flex; align-items:center; justify-content:center;">
                    <span class="status-dot"></span> CASPAM Assistant (Online)
                </div>
            </header>

            <div class="messages" id="chatContainer">
                <!-- Messages will be inserted here -->
            </div>

            <div class="input-area">
                <input type="text" id="userInput" placeholder="Ask about faculty, events, or courses..." autocomplete="off">
                <button class="send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </main>

        <!-- History Sidebar (Desktop) -->
        <aside class="history-sidebar">
            <div class="history-header">
                <h3>Chat History</h3>
                <button onclick="exportHistory()" class="history-btn">ðŸ“¥</button>
                <button onclick="importHistory()" class="history-btn">ðŸ“¤</button>
            </div>
            <div id="historyList" class="history-list"></div>
        </aside>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <h3 style="color:white; margin-bottom:15px;">Settings</h3>
            <label style="color:#aaa; font-size:0.8rem;">Update API Key (Optional)</label>
            <input type="password" id="apiKeyInput" placeholder="gsk_...">
            <button class="btn" onclick="saveApiSettings()">Save & Close</button>
            <button class="btn" style="background:#333; margin-top:5px;" onclick="document.getElementById('apiModal').classList.remove('active')">Cancel</button>
        </div>
    </div>
    <script>
    /* ========================================
       1. CONFIGURATION & DATA
       ======================================== */

    const CONFIG_CODE = "eyJtaXNzaW9uIjoiQ0FTUEFNIGVudmlzaW9ucyB0byBhdHRhaW4gaGVpZ2h0cyBvZiBleGNlbGxlbmNlIHRocm91Z2ggcXVhbGl0eSBhY2FkZW1pYyB0ZWFjaGluZywgbGVhcm5pbmcgYW5kIHJlc2VhcmNoIHNvIGFzIHRvIGRldmVsb3AgaW5kaXZpZHVhbHMsIGluZHVzdHJ5IGFuZCBzb2NpZXR5IGludGVsbGVjdHVhbGx5LCBwcm9mZXNzaW9uYWxseSBhbmQgZXRoaWNhbGx5LiBDQVNQQU0gaXMgd29ya2luZyB3aXRoIG1pc3Npb25hcnkgemVhbCBhbmQgemVzdCB0byBhZHZhbmNlIHVuaWZpY2F0aW9uIG9mIHdvcmxkbHkga25vd2xlZGdlIG9mIFNjaWVuY2VzLCBBcnRzLCBIdW1hbml0aWVzIGFuZCBvdGhlciBhcmVhcyBvZiBzY2hvbGFyc2hpcCB0aHJvdWdoIGhpZ2ggcXVhbGl0eSBpbnRlci1kaXNjaXBsaW5hcnkgaW5ub3ZhdGl2ZSB0ZWFjaGluZywgbGVhcm5pbmcgYW5kIHJlc2VhcmNoIGluIHRoZSBmaWVsZHMgb2YgUHVyZSwgQXBwbGllZCwgQ29tcHV0YXRpb25hbCwgRmluYW5jaWFsIGFuZCBJbmR1c3RyaWFsIE1hdGhlbWF0aWNzIGFuZCBkZXZlbG9wIGludGVsbGVjdHVhbCwgZXhwZXJ0LCBwcm9mZXNzaW9uYWwgYW5kIGV0aGljYWwgaHVtYW4gcmVzb3VyY2UgbmVjZXNzYXJ5IGZvciB0ZWNobm9sb2dpY2FsIGRldmVsb3BtZW50IG9mIGluZHVzdHJ5IGFuZCBiZXR0ZXJtZW50IG9mIHNvY2lldHkgYW5kIGh1bWFuaXR5IHRvIHJlYWxpemUgaXRzIG1vdHRvIOKAnE1hdGhlbWF0aWNzIGZvciBJbmR1c3RyeSwgU29jaWV0eSBhbmQgSHVtYW5pdHnigJ0uIiwiYWJvdXQiOiJDQVNQQU0gaGFzIGVzdGFibGlzaGVkIGEgaGlnaCByZXB1dGF0aW9uIGZvciBpdHMgZXhjZXB0aW9uYWwgc3RhbmRhcmRzIGluIHRlYWNoaW5nLCByZXNlYXJjaCBhbmQgaG9saXN0aWMgZGV2ZWxvcG1lbnQuIEhpZ2hseSBxdWFsaWZpZWQgZmFjdWx0eSB3aXRoIHNvdW5kIHByb2Zlc3Npb25hbCBhbmQgbW9yYWwgdmFsdWVzLCBvcGVuLCBpbmNsdXNpdmUsIGNvbXBldGl0aXZlLCBlbmNvdXJhZ2luZywgc3VwcG9ydGl2ZSBhbmQgY29uZHVjaXZlIHRlYWNoaW5nIGFuZCBsZWFybmluZyBlbnZpcm9ubWVudCwgaW5ub3ZhdGl2ZSwgaW50ZXJhY3RpdmUgYW5kIHRlY2hub2xvZ3ktYmFzZWQgbWV0aG9kcyBvZiB0ZWFjaGluZyBsZWFkaW5nIHRvIG91dGNvbWUgYmFzZWQgZWR1Y2F0aW9uLCBzdGF0ZSBvZiB0aGUgYXJ0IGluZnJhc3RydWN0dXJlLCBzdHVkZW50cyBjb3VuY2lscyBmb3IgZGV2ZWxvcGluZyBsZWFkZXJzaGlwIHF1YWxpdGllcyBhbmQgc29mdCBza2lsbHMsIGFjdGl2aXRpZXMgcHJvbW90aW5nIGFjYWRlbWlhLWluZHVzdHJ5IGxpbmthZ2VzLCBtb2Rlcm4gYW5kIGRpdmVyc2UgYXJlYXMgb2YgcmVzZWFyY2ggYW5kIHN0cm9uZyBhbHVtbmkgbmV0d29yayBoYXZlIG1hZGUgQ0FTUEFNIGFuIGV4Y2VwdGlvbmFsbHkgYXR0cmFjdGl2ZSBwbGFjZSBpbXBhcnRpbmcgdW5kZXJncmFkdWF0ZSBhbmQgZ3JhZHVhdGUgc3R1ZGllcyBmb3IgaGlnaGx5IG1vdGl2YXRlZCwgY2FyZWVyb3JpZW50ZWQgYW5kIGZvY3VzZWQgc3R1ZGVudHMuIENBU1BBTSBiZWxpZXZlcyBpbiBhbmQgZW5kZWF2b3JzIGZvciBob2xpc3RpYyBkZXZlbG9wbWVudCBvZiBpdHMgc3R1ZGVudHMgYW5kIG1ha2luZyB0aGVtIGNyZWF0aXZlLCBpbm5vdmF0aXZlIGFuZCBjYXBhYmxlIG9mIGNvbmR1Y3RpbmcgY3V0dGluZy1lZGdlIHJlc2VhcmNoIHNvIHRoYXQgdGhleSBtYXkgZWZmZWN0aXZlbHkgcGxheSB0aGVpciByb2xlIGluIHRyYW5zZm9ybWluZyB0aGUgaW5kdXN0cnksIHNvY2lldHkgYW5kIGh1bWFuaXR5IHNvIGFzIHRvIG1ha2UgdGhpcyB3b3JsZCBwZWFjZWZ1bCBhbmQgY29tZm9ydGFibGUgdG8gbGl2ZSBpbi4gQXQgQ0FTUEFNLCB3ZSByZWNvZ25pemUgdGhlIGdyb3dpbmcgc2lnbmlmaWNhbmNlIG9mIHRoZSByb2xlIG9mIE1hdGhlbWF0aWNzLCBpbiBnZW5lcmFsLCBpbiB0aGUgcHJlc2VudC1kYXkgd29ybGQgYW5kIHRoYXQgb2YgYnVzaW5lc3MsIGluZHVzdHJpYWwsIGZpbmFuY2lhbCBhbmQgY29tcHV0YXRpb25hbCBNYXRoZW1hdGljcyBpbiBwYXJ0aWN1bGFyIGFuZCBpdHMgaW50ZWdyYXRpb24gd2l0aCB0aGUgYXJ0aWZpY2lhbCBpbnRlbGxpZ2VuY2UgKEFJKSwgZGF0YSBzY2llbmNlLCBpbmZvcm1hdGljcywgaW5mb3JtYXRpb24gdGVjaG5vbG9naWVzLCBhbmQgbWFjaGluZSBsZWFybmluZyBmb3IgbWVldGluZyB0aGUgY2hhbGxlbmdlcyBvZiBpbmR1c3RyaWFsIHJldm9sdXRpb25zIDQuMCBhbmQgNS4wIGFuZCBhY2hpZXZpbmcgc3VzdGFpbmFibGUgZGV2ZWxvcG1lbnQgZ29hbHMgKFNER3MpLiBXZSBvZmZlciBCUywgTVMvTVBoaWwgYW5kIFBoRCBpbiBNYXRoZW1hdGljcyB0b2dldGhlciB3aXRoIHRoZXNlIG1vZGVybiBhcmVhcyBvZiBrbm93bGVkZ2UgYW5kIHNraWxscyBzbyB0aGF0IG91ciBncmFkdWF0ZXMgY291bGQgZW1iYXJrIG9uIGFuIGV4Y2l0aW5nIGpvdXJuZXkgb2YgZXhwbG9yYXRpb24sIGRpc2NvdmVyeSwgaW50ZWxsZWN0dWFsIGdyb3d0aCBhbmQgcGVyc29uYWwgZGV2ZWxvcG1lbnQsIGFuZCBwdXJzdWUgYSBjYXJlZXIgcGF0aCBvZiB0aGVpciBvd24gaW50ZXJlc3Qgb3V0IG9mIHRoZSBkaXZlcnNlIGNhcmVlciBwYXRocyBhdmFpbGFibGUgYXQgQ0FTUEFNLlxuXG5PdXIgc3R1ZHkgcHJvZ3JhbXMgZm9jdXMgb24gY3JpdGljYWwgdGhpbmtpbmcsIGFwcGx5aW5nIGZ1bmRhbWVudGFsIGNvbmNlcHRzLCBhbmFseXppbmcgcmVhbGxpZmUgcHJvYmxlbXMsIGlkZWEgZ2VuZXJhdGlvbiwgbW9kZWwgZGV2ZWxvcG1lbnQsIGFsZ29yaXRobSB3cml0aW5nLCBhbmQgc29sdXRpb24gdW5kZXJzdGFuZGluZy4gTWF0aGVtYXRpY3MsIGFsb25nc2lkZSB0YWJsZXMgYW5kIGdyYXBocywgYWlkcyBpbiBtb2RlbGluZyBhbmQgY29tcHJlaGVuZGluZyBwcm9ibGVtcyBmcm9tIHZhcmlvdXMgZmllbGRzLiBTdHVkZW50cyBub3Qgb25seSBnYWluIHRlcm1pbm9sb2d5IGZvciBncmFzcGluZyBjb25jZXB0cyBpbiBzY2llbmNlLCB0ZWNobm9sb2d5LCBlbmdpbmVlcmluZywgYnVzaW5lc3MsIGVjb25vbWljcywgZmluYW5jZSwgZGVjaXNpb24gbWFraW5nLCBhbmQgZGF0YSBtaW5pbmcgYnV0IGFsc28gbGVhcm4gY3JpdGljYWwgYW5kIGFuYWx5dGljYWwgdGhpbmtpbmcsIHF1YW50aXRhdGl2ZSByZWFzb25pbmcsIGFuZCBjb25jZXB0IGdlbmVyYWxpemF0aW9uLiBCeSBzdGF5aW5nIHVwLXRvLWRhdGUgd2l0aCB0aGUgbGF0ZXN0IGRldmVsb3BtZW50cyBpbiBNYXRoZW1hdGljcywgb3VyIHByb2dyYW1zIGVuc3VyZSB0aGF0IHN0dWRlbnRzIGFyZSB3ZWxscHJlcGFyZWQgdG8gdGFja2xlIHJlYWwtd29ybGQgY2hhbGxlbmdlcyBhbmQgY29udHJpYnV0ZSB0byB0aGUgYWR2YW5jZW1lbnQgb2YgdGhlIGRpc2NpcGxpbmUuIFRoaXMgbWFrZXMgdGhlbSBjYXBhYmxlIG9mIGZpbmRpbmcgcm9sZXMgc3VjaCBhcyBkYXRhIHNjaWVudGlzdHMsIGFjdHVhcmllcywgYnVzaW5lc3MgYW5kIGZpbmFuY2lhbCBhbmFseXN0cywgaW5kdXN0cmlhbCByZXNlYXJjaGVycyBhbmQgcHJvYmxlbS1zb2x2ZXJzIGluIHRoZSBhcmVhcyBvZiBkZXNpZ24sIGFuYWx5c2lzLCBvcHRpbWl6YXRpb24gYW5kIGF1dG9tYXRpb24uIiwiZ29hbHMiOiIxLiBFc3RhYmxpc2ggYSByZXNlYXJjaCBjdWx0dXJlLjxicj4yLiBNb2Rlcm5pemUgY3VycmljdWx1bSB3aXRoIEFJL01MLjxicj4zLiBQcm9tb3RlIG1hdGhlbWF0aWNhbCB0aGlua2luZyBpbiBkYWlseSBsaWZlLiIsInJvbGVzIjoiRGlyZWN0b3I6IFByb2YuRHIuIEltcmFuIEphdmVkPGJyPkRlcGFydG1lbnRhbCBTdHVkZW50IEFkdmlzb3IoRFNBKTogUHJvZi4gRHIuIFN5ZWQgQWh0c2hhbS1VbC1IYXEgQm9raGFyaSAoRm9yIG1hbGUpICYgRHIuIFNhZmlhIE1pcnphIChGb3IgRmVtYWxlKTxicj5EZXBhcnRtZW50YWwgRXhhbWluYXRpb24gSW5jaGFyZ2U6IERyLiBNdWhhbW1hZCBBc2lmPGJyPiBDbGVyazogRmFpc2FsIEJhandhIDxicj4gUmVzdWx0IG9yZ2FuaXplcjogTXVoYW1tYWQgV2FxYXM8YnI+TGFiIEluY2hhcmdlOiBNdWhhbW1hZCBJbXJhbjxicj4iLCJmYWN1bHR5IjoiUHJvZi5Eci5JbXJhbiBKYXZlZCB8IFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9NDUzfCBEZXRhaWxzOiBNeSBjb3Vyc2VzIGluY2x1ZGUgQWN0dWFyaWFsIE1hdGhlbWF0aWNzLCBNYXRoZW1hdGljYWwgRm91bmRhdGlvbnMgb2YgRmluYW5jZSwgQnVzaW5lc3MgQW5hbHl0aWNzLCBPcGVyYXRpb25zIFJlc2VhcmNoLCBEYXRhIEFuYWx5c2lzIHVzaW5nIEV4Y2VsLCBPcHRpbWl6YXRpb24gVGhlb3J5LCBQcm9iYWJpbGl0eSBUaGVvcnkgYW5kIE1hdGhlbWF0aWNhbCBTdGF0aXN0aWNzLCBMaW5lYXIgQWxnZWJyYSwgTWF0cml4IENvbXB1dGF0aW9uLCBDYWxjdWx1cyBJLUlJSSwgUmVhbCBBbmFseXNpcywgQ29udHJvbCBUaGVvcnksIENvbWJpbmF0b3JpY3MgYW5kIEdyYXBoIFRoZW9yeSwgQWxnZWJyYWljIEdyYXBoIFRoZW9yeSwgT3JkaW5hcnkgJiBQYXJ0aWFsIERpZmZlcmVudGlhbCBFcXVhdGlvbiwgRnV6enkgR3JhcGhzIGFuZCBGdXp6eSBIeXBlcmdyYXBocywgQ29tcGxleCBBbmFseXNpcywgQWxnZWJyYSwgR3JvdXAgVGhlb3J5IGFuZCBNYXRoZW1hdGljYWwgTWV0aG9kcy1JLiBcblByb2YuRHIuIEtoYWxpZCBTYWlmdWxsYWggU3llZCB8IFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9NDk2IHwgRGV0YWlsczogQ29tcHV0YXRpb25hbCBGbHVpZCBEeW5hbWljcywgT3B0aW1hbCBTaGFwZS9TeXN0ZW0gRGVzaWduLCBIZWF0IEV4Y2hhbmdlcnMsIFNwZWVjaCBQcm9kdWN0aW9uLCBJbnRlcm5hbCBDb21idXN0aW9uIEVuZ2luZXMsIE1vZGVsaW5nIGFuZCBTaW11bGF0aW9uIG9mIEluZHVzdHJpYWwgU3lzdGVtcywgQU5OIE1vZGVsaW5nLCBJbnRlbGxpZ2VudCBDb250cm9sIFN5c3RlbXMsIERhdGEtZHJpdmVuIFN5c3RlbXMsIEZhdWx0IERpYWdub3N0aWMgU3lzdGVtcywgUXVhbnR1bSBDb21wdXRpbmcsIFF1YW50dW0gTWFjaGluZSBMZWFybmluZy5cblByb2YgRHIuIE11aGFtbWFkIEFzaHJhZiB8IFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9NDk3IHwgRGV0YWlsczogRmx1aWQgZHluYW1pY3MsIENGRCwgSGVhdCBhbmQgbWFzcyB0cmFuc2ZlciwgSHlicmlkIG5hbm9mbHVpZHMsIGJpb2ZsdWlkcy5cblByb2YgRHIuIFVzbWFuIEFsaSB8IFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9NDk4IHwgRGV0YWlsczogS25vdCBUaGVvcnksIENvbWJpbmF0b3JpY3MsIEFsZ2VicmFpYyBHcmFwaCBUaGVvcnksIE1hdHJvaWQgVGhlb3J5LCBMb3ctRGltZW5zaW9uYWwgVG9wb2xvZ3lcblByb2YgRHIuIEZhaXNhbCBBbGkgfCBQcm9mZXNzb3IgfCBMaW5rOiBodHRwczovL2J6dS5lZHUucGsvdmlld19mYWN1bHR5LnBocD9kZXB0SUQ9NDAmZmFjdWx0eUlEPTUwMCB8IERldGFpbHM6TnVtZXJpY2FsIEFuYWx5c2lzLCBOdW1lcmljYWwgRnVuY3Rpb25hbCBBbmFseXNpcywgR3JhcGggVGhlb3J5LCBSaW5nIFRoZW9yeSwgRml4ZWQgUG9pbnQgVGhlb3J5LCBBSSBCYXNlZCBEZWNpc2lvbiBNYWtpbmcuXG5Qcm9mIERyLiBGaXphIFphZmFyIHwgUHJvZmVzc29yIHwgTGluazogaHR0cHM6Ly9ienUuZWR1LnBrL3ZpZXdfZmFjdWx0eS5waHA/ZGVwdElEPTQwJmZhY3VsdHlJRD01MDEgfCBEZXRhaWxzOkluZm9ybWF0aW9uLXRoZW9yZXRpYyBpbmVxdWFsaXRpZXMsIE51bWVyaWNhbCBzb2x1dGlvbiBhbmQgc3RhYmlsaXR5IGFuYWx5c2lzIG9mIG5vbmxpbmVhciBhbGdlYnJhaWMgZXF1YXRpb25zLCBOdW1lcmljYWwgb3B0aW1pemF0aW9uIHVzaW5nIG1ldGFoZXVyaXN0aWMgYWxnb3JpdGhtcywgTWF0cml4IGFuZCB0ZW5zb3IgZGVjb21wb3NpdGlvbnMgZm9yIGRhdGEgYW5hbHlzaXMuXG5Qcm9mIERyLiBTeWVkIEFodHNoYW0tVWwtSGFxIEJva2hhcmkgfCBQcm9mZXNzb3IgfCBMaW5rOiBodHRwczovL2J6dS5lZHUucGsvdmlld19mYWN1bHR5LnBocD9kZXB0SUQ9NDAmZmFjdWx0eUlEPTUwMiB8IERldGFpbHM6IERpc2NyZXRlIE1hdGhlbWF0aWNzOiBDb21iaW5hdG9yaWNzIGFuZCBHcmFwaCBUaGVvcnksIENyeXB0b2dyYXBoeS5cbkRyLiBNdWhhbW1hZCBBc2lmIHxBc3NvY2lhdGUgUHJvZmVzc29yIHwgTGluazogaHR0cHM6Ly9ienUuZWR1LnBrL3ZpZXdfZmFjdWx0eS5waHA/ZGVwdElEPTQwJmZhY3VsdHlJRD02MTUgfCBEZXRhaWxzOkZ1bmN0aW9uYWwgQW5hbHlzaXMsIEhhcm1vbmljIEFuYWx5c2lzLlxuRHIuIEF3YWlzIFlvbnVzIHxBc3NvY2lhdGUgUHJvZmVzc29yIHwgTGluazogaHR0cHM6Ly9ienUuZWR1LnBrL3ZpZXdfZmFjdWx0eS5waHA/ZGVwdElEPTQwJmZhY3VsdHlJRD04NTN8IERldGFpbHM6Q29udHJvbCBUaGVvcnksIEZyYWN0aW9uYWwgRGlmZmVyZW50aWFsIEVxdWF0aW9ucywgSW50ZXJ2YWwgQW5hbHlzaXMsIFRpbWUgU2NhbGUgQ2FsY3VsdXMsIEludmVudG9yeSBNYW5hZ2VtZW50IE1vZGVsaW5nLlxuRHIuIEFzZmFuZCBGYWhhZCB8QXNzb2NpYXRlIFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9NTA4IHwgRGV0YWlsczpNYXRoZW1hdGljYWwgQW5hbHlzaXMsIE1hdGhlbWF0aWNhbCBJbmVxdWFsaXRpZXMgYW5kIEFwcGxpY2F0aW9ucywgR3JhcGggVGhlb3J5IGFuZCBBcHBsaWNhdGlvbnMuXG5Eci4gQW1qYWQgQWxpIHxBc3NvY2lhdGUgUHJvZmVzc29yIHwgTGluazogaHR0cHM6Ly9ienUuZWR1LnBrL3ZpZXdfZmFjdWx0eS5waHA/ZGVwdElEPTQwJmZhY3VsdHlJRD01MDQgfCBEZXRhaWxzOkFydGlmaWNpYWwgSW50ZWxsaWdlbmNlLCBNYWNoaW5lIExlYXJuaW5nLCBEZWVwIExlYXJuaW5nLCBQYXJhbGxlbCBDb21wdXRpbmcsIFNjaWVudGlmaWMgQ29tcHV0aW5nLCBDb21wdXRhdGlvbmFsIEZsdWlkIER5bmFtaWNzLlxuRHIuIE11aGFtbWFkIElicmFoaW0gfEFzc2lzdGFudCBQcm9mZXNzb3IgfCBMaW5rOiBodHRwczovL2J6dS5lZHUucGsvdmlld19mYWN1bHR5LnBocD9kZXB0SUQ9NDAmZmFjdWx0eUlEPTUwNSB8IERldGFpbHM6R3JhcGggVGhlb3J5LCBOdW1lcmljYWwgQW5hbHlzaXMsIENvbXB1dGVyIE5ldHdvcmtzLCBDcnlwdG9ncmFwaHksIFNlY3VyaXR5IE5ldHdvcmtzLCBUb3BvbG9naWNhbCBHcmFwaCBUaGVvcnkuXG5Eci4gU2hlaHphZCBBaG1lZCB8QXNzaXN0YW50IFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9NTA2IHwgRGV0YWlsczpDb21wdXRhdGlvbmFsIEZsdWlkIER5bmFtaWNzLlxuRHIuIEFuYW0gUmFuaSB8QXNzaXN0YW50IFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9OTIyIHwgRGV0YWlsczpDb21tdXRhdGl2ZSBBbGdlYnJhLCBDb21iaW5hdG9yaWFsIENvbW11dGF0aXZlIEFsZ2VicmEsIEFsZ2VicmFpYywgQ2hlbWljYWwgJiBDb21wbGV4IE5ldHdvcmsgR3JhcGggVGhlb3J5LCBNYXRoZW1hdGljYWwgTW9kZWxsaW5nLCBHcmFwaCBOZXVyYWwgTmV0d29ya3MgKEdOTikgYW5kIGFwcGxpY2F0aW9ucyBpbiBiaW9sb2d5ICYgY2hlbWlzdHJ5LCBDcnlwdG9ncmFwaGljIGFwcGxpY2F0aW9ucyBvZiBhbGdlYnJhICYgZ3JhcGggdGhlb3J5LlxuRHIuIEF0aGFyIEtoYXJhbCB8QXNzaXN0YW50IFByb2Zlc3NvciB8IExpbms6IGh0dHBzOi8vYnp1LmVkdS5way92aWV3X2ZhY3VsdHkucGhwP2RlcHRJRD00MCZmYWN1bHR5SUQ9MTgyIHwgRGV0YWlsczpBcHBsaWVkIERhdGEgU2NpZW5jZSwgRnV6enkgVG9wb2xvZ2llcywgTUNETSwgU29mdCBhbmQgUm91Z2ggU2V0cyBhbmQgdGhlaXIgVmFyaWFudHMuXG5Eci4gU2FmaWEgTWlyemEgfEFzc2lzdGFudCBQcm9mZXNzb3IgfCBMaW5rOiBodHRwczovL2J6dS5lZHUucGsvdmlld19mYWN1bHR5LnBocD9kZXB0SUQ9NDAmZmFjdWx0eUlEPTUwN3wgRGV0YWlsczpEaWZmZXJlbnRpYWwvUGFydGlhbCBFcXVhdGlvbnMsIER5bmFtaWMgc3lzdGVtcywgRmx1aWQgTWVjaGFuaWNzLCBUaW1lIHNjYWxlIHRoZW9yeS5cbkRyLiBNdWhhbW1hZCBJbXJhbiBLaGFsaWQgfExlY3R1cmVyIHwgTGluazogaHR0cHM6Ly9ienUuZWR1LnBrL3ZpZXdfZmFjdWx0eS5waHA/ZGVwdElEPTQwJmZhY3VsdHlJRD05NTMgfCBEZXRhaWxzOkdyYXBoIFRoZW9yeSwgQ29tcHV0YXRpb25hbCBDcnlwdG9ncmFwaHksIEZ1bmN0aW9uYWwgQW5hbHlzaXMsIE51bWVyaWNhbCBhbmFseXNpcywgQWxnYWJyYVxuIiwicHJvZ3JhbXMiOiJCUyBNYXRoZW1hdGljcywgTVBoaWwgQXBwbGllZCBNYXRoZW1hdGljcywgUGhEIFB1cmUgTWF0aGVtYXRpY3MsIFVuZGVyZ3JhZHVhdGUgUHJvZ3JhbXMsIEJTKDV0aCBTZW1lc3RlcikgUHJvZ3JhbSwgR3JhZHVhdGUgKE1TKVByb2dyYW0sIEdyYWR1YXRlIChQaEQpIFByb2dyYW0sIEFEUCBQcm9ncmFtcywgRGlwbG9tYSBQcm9ncmFtcywgQlMgQUksIEJTIERhdGEgU2NpZW5jZSIsImNvdXJzZXMiOiJNYWNoaW5lIExlYXJuaW5nLCBDcnlwdG9ncmFwaHksIFdlYiBUZWNobm9sb2d5LCBNYXRoZW1hdGljYWwgTW9kZWxpbmcsIFBvcnRmb2xpbyBUaGVvcnkgYW5kIFJpc2sgTWFuYWdlbWVudCwgQnVzaW5lc3MgSW50ZWxsaWdlbmNlLCBEYXRhIEFuYWx5dGljcywgQWN0dXJpYWwgTWF0aGVtYXRpY3MsIERlZXAgTGVhcm5pbmcsIFRpbWUgU2VyaWVzIEFuYWx5c2lzLCBPcGVyYXRpb24gUmVzZWFyY2goTWFuYWdlbWVudCBTY2llbmNlKSwgTWVhc3VyZSBUaGVvcnksIE9wdGltaXphdGlvbiBUaGVvcnksIEZ1bmN0aW9uYWwgQW5hbHlzaXMsIFJlYWwgQW5hbHlzaXMsIFN0b2NoYXN0aWMgQ2FsY3VsdXMsIE51bWVyaWNhbCBBbmFseXNpcywgR3JhcGggVGhlb3J5LCBMaW5lYXIgUHJvZ3JhbW1pbmcsIFByb2JhYmlsaXR5IGFuZCBTdGF0aXN0aWNzLCBQcm9ncmFtbWluZyB3aXRoIHB5dGhvbiwgT2JqZWN0IE9yaWVudGVkIFByb2dyYW1taW5nLCBEZXNpZ24gYW5kIEFuYWx5c2lzIG9mIEFsZ29yaXRobXMsIENhbGN1bHVzLCBEaXNjcmV0ZSBNYXRoZW1hdGljcywgT3JkaW5hcnkgRGlmZmVyZW50aWFsIEVxdWF0aW9ucywgUGFydGlhbCBEaWZmZXJlbnRpYWwgRXF1YXRpb25zLCBNYXBwbGUsIE1BVExBQiwgRm91bmRhdGlvbiBhbmQgYXBwbGljYXRpb25zIG9mIEdlbmVyYXRpdmUgQUksIEZ1enp5IFNldCBUaGVvcnksIEdhbWUgVGhlb3J5LCBDbGFzc2ljYWwgTWVjaGFuaWNzLCBDb21wbGV4IEFuYWx5c2lzLCBEYXRhIFN0cnVjdHVyZSBhbmQgQWxnb3JpdGhtcywgVmVjdG9yIGFuZCBUZW5zb3IgQW5hbHlzaXMsIEdyb3VwIFRoZW9yeSwgVG9wbG9neSBhbmQgTWV0cmljIFNwYWNlcyIsImV2ZW50cyI6IkFubnVhbCBNYXRoIE9seW1waWFkIChPY3QgMjAyNikgfCBEZXRhaWxzOiBBIGNvbXBldGl0aW9uIGZvciBhbGwgdW5pdmVyc2l0eSBzdHVkZW50cy4gVmVudWU6IE1haW4gSGFsbC5cblFhd2FsaSBOaWdodCBhbmQgQW5udWFsIEZ1bmN0aW9uIChGZWIgMTEsIDIwMjYpIHwgRGV0YWlsczogVG8gZW50ZXJ0YWluIHN0dWRlbnRzIGFuZCBwb2xpc2hpbmcgdGhlIGhpZGRlbiBza2lsbHMgb2YgdGhlIHN0dWRlbnRzIHRocm91Z2ggdGhlaXIgdGFsZW50IGluIHZhcmlvdXMgZmllbGRzLlxuU3BvcnRzIEdhbGEgKEZlYiA5ICYgRmViIDEwLCAyMDI2KSB8IERldGFpbHM6IEZvciBleHRyYSBjdXJyaWN1bGFyIEFjdGl2aXRpZXMgb2Ygc3R1ZGVudHMgaW5jbHVkaW5nIHNwb3J0cyBcbjEuIENyaWNrZXQgXG4yLiBGb290YmFsbCBcbjMuIEJhZG1pbnRvbiBcbjQuIFRhYmxlIFRlbm5pc1xuNS4gMTAwIE1ldGVyIFJhY2VcbjYuIFR1ZyBPZiBXYXJcbjcuIEx1ZG8gXG44LiAzMDAgTWV0ZXIgUmFjZSJ9";

    let DEPT_DATA = {};
    let dataLoadError = false;

    try {
        if (CONFIG_CODE.includes("Placeholder") || CONFIG_CODE.length < 100) {
            throw new Error("Config code appears to be a placeholder.");
        }
        DEPT_DATA = JSON.parse(atob(CONFIG_CODE));
    } catch (e) {
        console.error("Config Error", e);
        dataLoadError = true;
        DEPT_DATA = { mission: "Error", faculty: "Error" };
    }

    function getContext() {
        if (dataLoadError) {
            return "ERROR: Configuration Code is invalid or incomplete. Please regenerate code in admin.html and paste it into index.html.";
        }

        let contextStr = "You are a helpful, professional AI for CASPAM (BZU Multan).\n\n";

        if (DEPT_DATA.mission) contextStr += `MISSION: ${DEPT_DATA.mission}\n`;
        if (DEPT_DATA.about) contextStr += `ABOUT: ${DEPT_DATA.about}\n`;
        if (DEPT_DATA.goals) contextStr += `GOALS: ${DEPT_DATA.goals}\n`;
        if (DEPT_DATA.roles) contextStr += `ROLES: ${DEPT_DATA.roles}\n`;
        if (DEPT_DATA.faculty) contextStr += `FACULTY: ${DEPT_DATA.faculty}\n`;
        if (DEPT_DATA.programs) contextStr += `PROGRAMS: ${DEPT_DATA.programs}\n`;
        if (DEPT_DATA.courses) contextStr += `COURSES: ${DEPT_DATA.courses}\n`;
        if (DEPT_DATA.events) contextStr += `EVENTS: ${DEPT_DATA.events}\n`;

        contextStr += `\nInstructions: Be concise and helpful. Use Markdown for formatting (### for headings, **bold**).`;
        return contextStr;
    }

    /* ========================================
       2. CHAT HISTORY
       ======================================== */

    const HISTORY_KEY = 'caspam_chat_v5';

    function loadChatHistory() {
        const saved = localStorage.getItem(HISTORY_KEY);
        if (saved) {
            const history = JSON.parse(saved);
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            history.forEach(msg => {
                renderMessage(msg.content, msg.role === 'assistant' ? 'bot' : 'user', false);
            });
            scrollToBottom();
        } else {
            if (dataLoadError) {
                renderMessage("System Error: The Configuration Code in this file is invalid.", 'error', false);
            } else {
                renderMessage("Hello! I'm CASPAM AI. I have full access to Department info. How can I help?", 'bot', false);
            }
        }
    }

    function saveToHistory(role, content) {
        const saved = localStorage.getItem(HISTORY_KEY);
        let history = saved ? JSON.parse(saved) : [];
        history.push({ role, content });
        if (history.length > 20) history = history.slice(-20);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function getHistoryForAPI() {
        const saved = localStorage.getItem(HISTORY_KEY);
        if (!saved) return [];
        const history = JSON.parse(saved);
        return history.slice(-10).map(msg => ({
            role: msg.role,
            content: msg.content
        }));
    }

    function clearHistory() {
        if (confirm('Delete ALL chat history?')) {
            localStorage.removeItem('caspam_sessions');
            localStorage.removeItem(HISTORY_KEY);
            chatSessions = { current: null, sessions: {} };
            createNewSession();
        }
    }

    /* ========================================
       3. MARKDOWN PARSER
       ======================================== */

    function parseMarkdown(text) {
        if (!text) return '';
        let html = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/^- (.*)/gm, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        html = html.replace(/\n/g, '<br>');
        return html;
    }

    /* ========================================
       4. CORE FUNCTIONS
       ======================================== */

    function renderMessage(text, type, save = true) {
        const container = document.getElementById('chatContainer');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = type === 'bot' ? parseMarkdown(text) : text.replace(/\n/g, '<br>');
        container.appendChild(div);
        scrollToBottom();
        
        if (save) {
            saveToHistory(type === 'bot' ? 'assistant' : 'user', text);
            saveMessageToSession(type === 'bot' ? 'assistant' : 'user', text);
        }
    }

    function scrollToBottom() {
        const container = document.getElementById('chatContainer');
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;

        renderMessage(text, 'user');
        input.value = '';
        const loadingId = showLoading();

        try {
            const chatHistory = getHistoryForAPI();
            const apiMessages = [
                { role: "system", content: getContext() },
                ...chatHistory,
                { role: "user", content: text }
            ];

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: apiMessages
                })
            });

            if (!response.ok) throw new Error("API Connection Failed");

            const data = await response.json();
            removeLoading(loadingId);
            const botReply = data.choices[0].message.content;
            renderMessage(botReply, 'bot');

        } catch (error) {
            removeLoading(loadingId);
            renderMessage(`Error: ${error.message}.`, 'error');
        }
    }

    function showLoading() {
        const container = document.getElementById('chatContainer');
        const id = 'load-' + Date.now();
        const div = document.createElement('div');
        div.className = 'msg bot';
        div.id = id;
        div.innerHTML = '<div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
        container.appendChild(div);
        scrollToBottom();
        return id;
    }

    function removeLoading(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function resetChat() {
        createNewSession();
    }

    function saveApiSettings() {
        const newKey = document.getElementById('apiKeyInput').value.trim();
        if (newKey) API_KEY = newKey;
        document.getElementById('apiModal').classList.remove('active');
    }

    /* ========================================
       5. CHAT SESSIONS
       ======================================== */

    let chatSessions = {
        current: null,
        sessions: {}
    };

    function loadSessions() {
        const saved = localStorage.getItem('caspam_sessions');
        if (saved) {
            chatSessions = JSON.parse(saved);
        } else {
            createNewSession();
        }
        renderHistorySidebar();
        renderMobileHistory();
    }

    function createNewSession() {
        const sessionId = 'session_' + Date.now();

        if (chatSessions.current && chatSessions.sessions[chatSessions.current]) {
            saveCurrentSession();
        }

        chatSessions.current = sessionId;
        chatSessions.sessions[sessionId] = {
            id: sessionId,
            title: 'New Chat',
            preview: '',
            messages: [],
            date: new Date().toISOString()
        };

        document.getElementById('chatContainer').innerHTML = '';
        renderMessage("Chat session started. How can I help?", 'bot', false);

        saveSessions();
        renderHistorySidebar();
        renderMobileHistory();
    }

    function saveCurrentSession() {
        const sessionId = chatSessions.current;
        if (!sessionId || !chatSessions.sessions[sessionId]) return;

        const container = document.getElementById('chatContainer');
        const messages = [];

        container.querySelectorAll('.msg').forEach(msgEl => {
            const type = msgEl.classList.contains('user') ? 'user' : 'assistant';
            const content = msgEl.innerText;
            messages.push({ role: type, content });
        });

        chatSessions.sessions[sessionId].messages = messages;

        const userMessages = messages.filter(m => m.role === 'user');
        if (userMessages.length > 0) {
            chatSessions.sessions[sessionId].preview = userMessages[0].content.substring(0, 50);
            if (chatSessions.sessions[sessionId].title === 'New Chat') {
                chatSessions.sessions[sessionId].title = userMessages[0].content.substring(0, 30);
            }
        }
    }

    function saveMessageToSession(role, content) {
        const sessionId = chatSessions.current;
        if (!sessionId) return;

        if (!chatSessions.sessions[sessionId].messages) {
            chatSessions.sessions[sessionId].messages = [];
        }

        chatSessions.sessions[sessionId].messages.push({ role, content });

        if (role === 'user') {
            chatSessions.sessions[sessionId].preview = content.substring(0, 50);
            if (chatSessions.sessions[sessionId].title === 'New Chat') {
                chatSessions.sessions[sessionId].title = content.substring(0, 30);
            }
        }

        saveSessions();
        renderHistorySidebar();
        renderMobileHistory();
    }

    function loadSession(sessionId) {
        saveCurrentSession();

        const session = chatSessions.sessions[sessionId];
        if (!session) return;

        chatSessions.current = sessionId;

        const container = document.getElementById('chatContainer');
        container.innerHTML = '';

        session.messages.forEach(msg => {
            renderMessage(msg.content, msg.role === 'assistant' ? 'bot' : 'user', false);
        });

        saveSessions();
        renderHistorySidebar();
        renderMobileHistory();
        
        if (window.innerWidth <= 768) {
            closeMobileDrawer();
        }
    }

    function deleteSession(sessionId, event) {
        event.stopPropagation();
        
        if (confirm('Delete this chat?')) {
            delete chatSessions.sessions[sessionId];
            
            const remainingSessions = Object.keys(chatSessions.sessions).length;
            
            if (remainingSessions === 0) {
                chatSessions = {
                    current: null,
                    sessions: {}
                };
                createNewSession();
            } else {
                if (chatSessions.current === sessionId) {
                    const sortedSessions = Object.values(chatSessions.sessions)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    loadSession(sortedSessions[0].id);
                }
            }
            
            saveSessions();
            renderHistorySidebar();
            renderMobileHistory();
        }
    }

    function renameSession(sessionId, event) {
        event.stopPropagation();
        const newTitle = prompt('Enter new chat name:');
        if (newTitle) {
            chatSessions.sessions[sessionId].title = newTitle;
            saveSessions();
            renderHistorySidebar();
            renderMobileHistory();
        }
    }

    function saveSessions() {
        localStorage.setItem('caspam_sessions', JSON.stringify(chatSessions));
    }

    function renderHistorySidebar() {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;

        let html = '';

        const validSessions = Object.values(chatSessions.sessions)
            .filter(session => {
                return (session.messages && session.messages.length > 0) || session.id === chatSessions.current;
            })
            .sort((a, b) => new Date(b.date) - new Date(a.date));

        if (validSessions.length === 0) {
            html = '<div style="text-align: center; color: #555; padding: 20px;">No chat history</div>';
        } else {
            validSessions.forEach(session => {
                const isActive = session.id === chatSessions.current;
                const date = new Date(session.date).toLocaleDateString();
                const hasMessages = session.messages && session.messages.length > 0;
                
                const deleteButton = hasMessages ? 
                    `<button onclick="deleteSession('${session.id}', event)">ðŸ—‘ï¸</button>` : '';

                html += `
                    <div class="history-item ${isActive ? 'active' : ''}" onclick="loadSession('${session.id}')">
                        <div class="history-item-title">${session.title}</div>
                        <div class="history-item-preview">${session.preview || 'No messages'}</div>
                        <div class="history-item-date">${date}</div>
                        <div class="history-item-actions">
                            <button onclick="renameSession('${session.id}', event)">âœï¸</button>
                            ${deleteButton}
                        </div>
                    </div>
                `;
            });
        }

        historyList.innerHTML = html;
    }

    function renderMobileHistory() {
        const historyList = document.getElementById('mobileHistoryList');
        if (!historyList) return;

        let html = '';

        const validSessions = Object.values(chatSessions.sessions)
            .filter(session => {
                return (session.messages && session.messages.length > 0) || session.id === chatSessions.current;
            })
            .sort((a, b) => new Date(b.date) - new Date(a.date));

        if (validSessions.length === 0) {
            html = '<div style="text-align: center; color: #555; padding: 20px;">No chat history</div>';
        } else {
            validSessions.forEach(session => {
                const isActive = session.id === chatSessions.current;
                const date = new Date(session.date).toLocaleDateString();
                
                html += `
                    <div class="history-item ${isActive ? 'active' : ''}" onclick="loadSession('${session.id}'); closeMobileDrawer();">
                        <div class="history-item-title">${session.title}</div>
                        <div class="history-item-preview">${session.preview || 'No messages'}</div>
                        <div class="history-item-date">${date}</div>
                    </div>
                `;
            });
        }

        historyList.innerHTML = html;
    }

    function exportHistory() {
        const dataStr = JSON.stringify(chatSessions, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', `caspam-history-${new Date().toISOString().slice(0, 10)}.json`);
        link.click();
    }

    function importHistory() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = event => {
                try {
                    const imported = JSON.parse(event.target.result);
                    chatSessions = imported;
                    saveSessions();
                    loadSession(chatSessions.current);
                    renderHistorySidebar();
                    renderMobileHistory();
                    alert('History imported successfully!');
                } catch (error) {
                    alert('Invalid history file');
                }
            };

            reader.readAsText(file);
        };

        input.click();
    }

    /* ========================================
       6. MOBILE DRAWER FUNCTIONS
       ======================================== */

    function toggleMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('mobileOverlay');
        const btn = document.getElementById('mobileMenuBtn');
        
        drawer.classList.toggle('open');
        overlay.classList.toggle('active');
        btn.classList.toggle('active');
    }

    function closeMobileDrawer() {
        document.getElementById('mobileDrawer').classList.remove('open');
        document.getElementById('mobileOverlay').classList.remove('active');
        document.getElementById('mobileMenuBtn').classList.remove('active');
    }

    function switchDrawerTab(tabName) {
        document.querySelectorAll('.drawer-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        document.getElementById('menuTab').classList.remove('active');
        document.getElementById('historyTab').classList.remove('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        if (tabName === 'history') {
            renderMobileHistory();
        }
    }

    /* ========================================
       7. 3D VISUALS
       ======================================== */

    function initParticles() {
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.size = Math.random() * 2 + 1;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }
            draw() {
                ctx.fillStyle = 'rgba(0, 242, 255, 0.5)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function init() {
            particles = [];
            const count = Math.min(100, (width * height) / 10000);
            for (let i = 0; i < count; i++) particles.push(new Particle());
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = 'rgba(112, 0, 255, 0.1)';
            ctx.lineWidth = 1;

            for (let i = 0; i < particles.length; i++) {
                let p1 = particles[i];
                p1.update();
                p1.draw();
                for (let j = i + 1; j < particles.length; j++) {
                    let p2 = particles[j];
                    let dx = p1.x - p2.x;
                    let dy = p1.y - p2.y;
                    let dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) {
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', () => { resize(); init(); });
        resize();
        init();
        animate();
    }

    /* ========================================
       8. INITIALIZATION
       ======================================== */

    window.onload = () => {
        loadSessions();
        loadChatHistory();
        initParticles();
        
        document.querySelector('.main-chat').addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                closeMobileDrawer();
            }
        });
    };

    document.getElementById('userInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            closeMobileDrawer();
        }
    });
</script>
</body>
</html>

